openapi: 3.0.3

info:
  title: TaskMan API
  version: 1.3.0
  description: >
    REST API for project and task management with JWT authentication,
    Google OAuth2 login and role-based access control (RBAC).

servers:
  - url: http://localhost:8080/api

tags:
  - name: Auth
  - name: Users
  - name: Projects
  - name: Tasks
  - name: Comments

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    ValidationError:
        type: object
        properties:
          errors:
            type: object

    Error:
        type: object
        properties:
          message:
            type: string

    TokenPair:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string

    User:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        email:
          type: string
        googleId:
          type: string
          nullable: true
        isAdmin:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserMe:
      allOf:
        - $ref: "#/components/schemas/User"
        - type: object
          properties:
            googleLinked:
              type: boolean

    ProjectMember:
      type: object
      properties:
        userId:
          type: string
        role:
          type: string
          enum: [editor, viewer]

    Project:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        description:
          type: string
        ownerId:
          type: string
        members:
          type: array
          items:
            $ref: "#/components/schemas/ProjectMember"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Comment:
      type: object
      properties:
        _id:
          type: string
        authorId:
          type: string
        content:
          type: string
        createdAt:
          type: string
          format: date-time

    Task:
      type: object
      properties:
        _id:
          type: string
        projectId:
          type: string
        parentTaskId:
          type: string
          nullable: true
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [todo, in-progress, done]
        priority:
          type: string
          enum: [low, medium, high]
        assignedTo:
          type: string
          nullable: true
        dueDate:
          type: string
          format: date
          nullable: true
        comments:
          type: array
          items:
            $ref: "#/components/schemas/Comment"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

paths:

  # =====================
  # AUTH
  # =====================

  /auth/register:
    post:
      tags: [Auth]
      summary: Register with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name:
                  type: string
                email:
                  type: string
                password:
                  type: string
      responses:
        "201":
          description: Registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPair"
        "409":
          description: Email already registered

  /auth/login:
    post:
      tags: [Auth]
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: Logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPair"
        "401":
          description: Invalid credentials

  /auth/google:
    get:
      tags: [Auth]
      summary: Google OAuth2 login / registration
      responses:
        "302":
          description: Redirect to Google OAuth

  /auth/refresh-token:
    post:
      tags: [Auth]
      summary: Refresh JWT tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        "200":
          description: New token pair
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPair"

  # =====================
  # USERS
  # =====================

  /users/me:
    get:
      tags: [Users]
      summary: Get current user
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserMe"

  # =====================
  # PROJECTS
  # =====================

  /projects/{projectId}/members:
    get:
      tags: [Projects]
      summary: Get project members
      description: >
        Returns all members of the project.
        Allowed roles: admin, owner, editor, viewer.
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Project members
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    userId:
                      type: string
                    name:
                      type: string
                    email:
                      type: string
                    role:
                      type: string
                      enum: [editor, viewer]
        "403":
          description: Forbidden
        "404":
          description: Project not found

    post:
      tags: [Projects]
      summary: Add project member
      description: >
        Add a user to the project by email.
        Allowed roles: admin, project owner.
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                role:
                  type: string
                  enum: [editor, viewer]
                  default: viewer
      responses:
        "201":
          description: Member added
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                  email:
                    type: string
                  role:
                    type: string
                    enum: [editor, viewer]
        "400":
          description: Invalid input
        "403":
          description: Forbidden
        "404":
          description: User not found
        "409":
          description: User already member

  /projects/{projectId}/members/{userId}:
    patch:
      tags: [Projects]
      summary: Update project member role
      description: >
        Change role of a project member.
        Allowed roles: admin, project owner.
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
                  enum: [editor, viewer]
      responses:
        "200":
          description: Member role updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectMember"
        "403":
          description: Forbidden
        "404":
          description: Member not found

    delete:
      tags: [Projects]
      summary: Remove project member
      description: >
        Remove a user from the project.
        Allowed roles: admin, project owner.
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Member removed
        "403":
          description: Forbidden
        "404":
          description: Member not found

  /projects:
    get:
      tags: [Projects]
      summary: Get projects
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Project"

    post:
      tags: [Projects]
      summary: Create project
      description: >
        RBAC: authenticated user.
        Owner must exist.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, ownerId]
              properties:
                name:
                  type: string
                description:
                  type: string
                status:
                  type: string
                  enum: [active, on-hold, done]
                dueDate:
                  type: string
                  format: date
                ownerId:
                  type: string
      responses:
        "201":
          description: Project created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          description: Validation error / user not found
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Error"
                  - $ref: "#/components/schemas/ValidationError"
        "500":
          description: Server error

  /projects/{projectId}:
    get:
      tags: [Projects]
      summary: Get project
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"

    patch:
      tags: [Projects]
      summary: Update project
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Project updated

    delete:
      tags: [Projects]
      summary: Delete project
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Project deleted

  /projects/{projectId}/with-tasks:
    get:
      tags: [Tasks]
      summary: Get project tasks
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"

  # =====================
  # TASKS
  # =====================

  /projects/{projectId}/tasks:
    post:
      tags: [Tasks]
      summary: Create task
      description: >
        RBAC: admin | project owner | editor
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title:
                  type: string
                description:
                  type: string
                status:
                  type: string
                  enum: [todo, in-progress, done]
                priority:
                  type: string
                  enum: [low, medium, high]
                assignedTo:
                  type: string
                  nullable: true
                parentTaskId:
                  type: string
                  nullable: true
                dueDate:
                  type: string
                  format: date
      responses:
        "201":
          description: Task created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Invalid project / user / parent task
        "403":
          description: Forbidden
        "500":
          description: Server error

  /projects/{projectId}/tasks/{taskId}:
    get:
      tags: [Tasks]
      summary: Get task
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Task
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"

    patch:
      tags: [Tasks]
      summary: Update task
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
        - name: taskId
          in: path
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Task updated

    delete:
      tags: [Tasks]
      summary: Delete task
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
        - name: taskId
          in: path
          required: true
      responses:
        "204":
          description: Task deleted

  # =====================
  # COMMENTS
  # =====================

  /projects/{projectId}/tasks/{taskId}/comments:
    get:
      tags: [Comments]
      summary: Get comments
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
        - name: taskId
          in: path
          required: true
      responses:
        "200":
          description: Comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Comment"

    post:
      tags: [Comments]
      summary: Create comment
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
        - name: taskId
          in: path
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        "201":
          description: Comment created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Comment"

  /projects/{projectId}/tasks/{taskId}/comments/{commentId}:
    delete:
      tags: [Comments]
      summary: Delete comment
      security:
        - BearerAuth: []
      parameters:
        - name: projectId
          in: path
          required: true
        - name: taskId
          in: path
          required: true
        - name: commentId
          in: path
          required: true
      responses:
        "204":
          description: Comment deleted

  /comments/{commentId}:
    patch:
      tags: [Comments]
      summary: Update comment
      security:
        - BearerAuth: []
      parameters:
        - name: commentId
          in: path
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        "200":
          description: Comment updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Comment"
